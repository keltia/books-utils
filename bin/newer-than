#! /usr/bin/env ruby
#
# @abstract extract books newer than given date from Calibre catalog
# @author Ollivier Robert <roberto@keltia.net>
# @copyright 2014 by Ollivier Robert
#
# XXX Uses calibredb to extract most data
#
# REQUIRES: command-line Calibre utilities to be installed
# REQUIRES: at least the 'added' custom column (see #added: in the request)
#
# Our name
MYNAME = File.basename($0)

$LOAD_PATH.unshift(File.join(__dir__, File.expand_path($0), '..', 'lib'))

# Standard modules
#
require 'csv'
require 'optparse'
require 'time'
require 'tmpdir'
require 'yaml'

# Non-standard modules
#
require 'oj'
require 'ox'

# My modules
#
require 'books/utils/version'

# On day in seconds
ONEDAY = (3600*24)

# Path to the tmp file for results
TMPDIR = ".newer-than"

# Check threshold
#
# @param [String|Fixnum] value threshold value to be checked
# @return [Time] precise time to checked upon
def check_threshold(threshold, that_date)
  # Check options
  #
  if threshold != 0 and that_date != nil
    $stderr.puts('Error: you can not specify both -d and -t!')
    return 255
  end

  # How did we specified the threshold?
  #
  if that_date.nil?
    newer_than = Time.at(Time.now.to_i - (threshold * ONEDAY))
  else
    #
    # If ALL is specified, get everything from the library with a date
    # old enough
    #
    if that_date == 'ALL'
      that_date = '2000-01-01'
    end
    newer_than = Time.parse(that_date)
  end
  newer_than.iso8601
end

# Get list
#
# @param [Fixnum] threshold number of days to check books for
# @return [Array] list of books id in CSV
def get_list(threshold, library_path = nil)
  book_list = nil
  raw_list  = nil

  # Wrap the temp directory
  #
  Dir.mktmpdir(TMPDIR) do |dir|

    # Use calibredb to fetch data
    #
    if library_path.nil?
      ret = %x{calibredb catalog #{dir}/calibre.csv -s 'date:>=#{threshold}' --fields 'title,authors,series,series_index' --sort-by 'authors'}
    else
      ret = %x{calibredb catalog #{dir}/calibre.csv -s 'date:>=#{threshold}' --with-library=#{library_path} --fields 'title,authors,series,series_index' --sort-by 'authors'}
    end

    # XXX Hack to remove the fscking BOM
    #
    rest = 0
    File.open("#{dir}/calibre.csv", 'r', encoding: 'UTF-8') do |fr|
      bom = fr.seek(3)
      rest = fr.read
      raw_list = CSV.parse(rest, converters: :numeric)
    end
  end

  # Turn this raw array of arrays into something usable
  #
  header_list = raw_list.shift
  book_list = raw_list.inject([]) {|list, e|
    he = Hash.new
    header_list.map {|h| he[h] = e[header_list.index(h)]}
    list << he
  }
end

# Output results in the desired format
#
# @param [Array] list    all the results
# @param [String] format use the specified format (default is plain display)
def output_results(list, newer_than, format = nil)
  case format
    when /json/
      puts Oj.dump(list)
    when /xml/
      puts Ox.dump(list, :effort => :tolerant)
    when /yaml/
      puts list.to_yaml
    else
      puts("#{list.length} new/updated books since #{newer_than}:\n\n")
      list.each do |bk|
         series = bk['series']
         if series == ''
           title = bk['title']
         else
           title = "#{bk['title']} (#{series}, ##{bk['series_index']})"
         end
         puts("Authors: %-25s\tTitle: %s" % [bk['authors'], title])
      end
  end
end

# Main method
#
# @param [Array] argv parameters
# @return [FixNum] exit code

def main(argv)
  # time_t time
  that_date = nil

  # text-based threshold for SQL
  threshold = 0

  # output format
  format = nil

  # Library path
  library_path = nil

  usage = <<-"EOTEXT"
Usage: #{MYNAME} [-h] [-D path] [-f format] [-d DATE | -t DAYS]

Default is 1 day.  Default format is space-delimited.
  EOTEXT

  banner = <<-"EOTEXT"
#{MYNAME} v#{Books::Utils::VERSION}

#{usage}
  EOTEXT

  argv.options do |opts|
    opts.banner = banner
    opts.on('-D', '--library=DIR', 'Use that library path instead of the default.') do
      |opt_dir|
      library_path = opt_dir
    end
    opts.on('-d', '--since=DATE', 'Use that date to search after') do
      |opt_date|
      that_date = opt_date
    end
    opts.on('-f', '--format=json|yaml|xml', 'Specify output format') do
      |opt_format|
      if opt_format !~ %r{json|yaml|xml}
        $stderr.puts("Error: invalid format #{opt_format}, use json|xml|yaml!")
        return 1
      end
      format = opt_format
    end
    opts.on('-t', '--newer-than=DAYS', 'Threshold date to look for') do
      |opt_newer|
      threshold = opt_newer.to_i
    end
    opts.on('-h', '--help', 'Display this usage') do
      puts opts.help
      return 255
    end
    opts.parse!
  end

  argv.options = nil

  # Manage options
  #
  newer_than = check_threshold(threshold, that_date)

  # Do the stuff
  #
  list = get_list(newer_than, library_path)

  # Convert/display results
  #
  output_results(list, newer_than, format)
  0
end

exit(main(ARGV) || 1)
